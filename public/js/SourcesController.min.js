angular.module("App").controller("SourcesCtrl",function(e,n,a,t,i,o,r,s,l,c){e.basic_search={page:1,page_size:30},e.search=angular.extend(e.basic_search,$.search.source()),e.me=$.search.source(),"?mine"===RunningLeeUrl.parse().search&&(a(function(){$("span.searchdroplist-clear",$("#search-clear")).trigger("click"),$("span.checkbox-text").text("不限"),$("li.erp-checkbox-list",$("#search-status")).removeClass("on").addClass("off"),$("li.erp-checkbox-list:eq(0)",$("#search-status")).removeClass("off").addClass("on"),$("#search-status").data("params",["不限"]).data("val","不限").data("default","不限"),$("body").data("search-status",null)},1),e.search.agent_id=e.gov.agent_id,e.search.status=null),e.markNum=0,t.get("/api/get-source-marks").then(function(n){n.data&&(e.markNum=n.data.length)}),e.selectSource={},t.get("/api/get-source-setting").then(function(n){e.settingSource=n.data.required,e.selectSource=n.data.select,e.configSource=n.data.source,e.is_show_HouseMess=!1,e.configSource.hidden_source_info.value?e.is_show_HouseMess=!1:e.is_show_HouseMess=!0,e.getLockedTitle=function(n){var a="";return n&&e.configSource.fengpan_days.value&&(a="封盘时间："+moment(n.locked_at).format("YYYY-MM-DD")+"，到期时间："+moment(n.locked_at).add(e.configSource.fengpan_days.value,"days").format("YYYY-MM-DD")+"，封盘方式："+n.locked_way),a}}),n.$on("reset-flag",function(n,a){e.dropDownToggleTrigger={room:!1,hall:!1,toilet:!1,decoration_level:!1,direction:!1,sale_status:!1,ownership_type:!1,arch_structure:!1,arch_type:!1,price_range:!1,archsqure_range:!1,delivery_at:!1};var t=a.btnFlagMark;e.dropDownToggleTrigger[t]=a.btnFlag}),e.ownership_types=o.community.ownership_types,e.arch_structures=o.community.arch_structres,e.arch_types=o.community.arch_types,e.directions=o.community.directions,e.decoration_levels=o.community.decoration_levels,e.qrShow=function(e){swal({title:"分享房源",text:e.community.title+" "+e.uuid,imageUrl:"qr?link="+e.loushu_url+"?time="+(new Date).getTime(),imageSize:"180x180",imageHeight:180,imageWidth:180,showCancelButton:!1,closeOnConfirm:!1,showLoaderOnConfirm:!0,confirmButtonText:"确定"})},e.comparedSources=function(){var e=n.selectedSources.length;e?e>4?Message.warning("比较的房源不能超过4个"):$("#comparedDiv").modal("show"):Message.warning("没有选择房源")},n.types={},n.schedule={type:"",due_at:"",finished_at:"",schedule_type:"sources",description:"",client_name:"",source_id:0,agent_id:"",call_id:""},e.sourceLoading=!1,e.showmoreInfo=function(n){e.sourceLoading||(e.sourceLoading=!0,e.markSourceRecord(n.id),$.loading.show(),t.get("/api/source/"+n.id).then(function(a){$.loading.hide();var t=Date.parse(new Date);r.open({backdrop:!1,templateUrl:"/source/next-sources.html?source_id="+n.id+"&time="+t,controller:"nextsourceSCtrl",appendTo:angular.element(document.getElementById("sources")),size:"dialog-800",resolve:{share:function(){return a.data.data.markNum=e.markNum,{source:a.data.data,access:a.data.access,agent:a.data.agent,is_public:e.search.is_public}}}}).result.then(function(a){e.sourceLoading=!1,e.markNum=a.markNum,n.if_pic=a.if_pic},function(){e.sourceLoading=!1})}))},e.addSell=function(){r.open({backdrop:!1,templateUrl:"sourceS.html",controller:"AddSourceAlertCtrl",appendTo:angular.element(document.getElementById("main-window")),size:"dialog-516",resolve:{share:function(){return{source:[],relations:e.selectSource.owner_relation.value}}}})},e.doUp=function(a){t.put("/api/source/"+a.id+"/top").then(function(e){Message.success("置顶成功"),n.schedule.call_id=e.id},function(n){Message.error(n),e.loading_add=!1})},e.mark=function(n){t.put("/api/source-mark/"+n.id).then(function(a){if(1==a.data.data){if(e.markIsFull)return Message.warning("收藏房源超过限制！"),!1;Message.success("收藏成功"),e.actSourceMark(n),e.markNum=a.data.total}else 0==a.data.data?(Message.success("取消收藏"),e.actSourceMark(n),e.markNum=a.data.total,e.markIsFull=!1):(e.markIsFull=!0,Message.warning("收藏房源超过限制！"))},function(n){Message.error(n),e.loading_add=!1})},e.actSourceMark=function(n){_.find(e.gridOptions.data,function(a,t){a.id==n.id&&(e.gridOptions.data[t].book_mark=!n.book_mark)})},e.show_community=function(){$("#CommunityModal").modal({backdrop:!1,keyboard:!1}),$("#CommunityModal").modal("show"),n.businessLists=[],n.CommunityLists=[]},e.partialCommunities={},e.communitySelected="",e.refreshCommunity=function(n){""!=n&&(e.search.keyword=n,e.search.status="已审核",t.get("/api/dictionary?"+$.param(e.search)).then(function(n){e.morecommunities=n.data.data}))},e.isSelected=function(e){n.search.community_id=e.id},e.getLocation=function(){e.getSources()},e.moreconditions="1",n.selectedSources=[],e.gridOptions={columnDefs:[{name:"码",enableSorting:!1,enableHiding:!1,enableColumnMenu:!1,width:40,pinnedLeft:!0,cellTemplate:"action.html"},{name:"标签",enableHiding:!1,enableColumnMenu:!1,enableSorting:!1,width:100,pinnedLeft:!0,cellTemplate:"other.html"},{name:"收藏",enableHiding:!1,enableColumnMenu:!1,enableSorting:!1,width:40,pinnedLeft:!0,headerCellClass:"text-center",cellTemplate:"sourceB.html"},{field:"category",displayName:"交易",enableHiding:!1,enableColumnMenu:!1,width:40,pinnedLeft:!0,headerCellClass:"text-center",cellTemplate:"sort.html"},{field:"sale_status",displayName:"状态",width:50,enableColumnMenu:!1,enableHiding:!1,pinned:!0,pinnedLeft:!0,cellTemplate:"sale_status.html"},{field:"community.title",displayName:"楼盘",visible:!0,enableColumnMenu:!1,enableHiding:!1,width:150,pinnedLeft:!0,cellTemplate:"loupan.html"},{field:"agency_house.ridgepole_name",displayName:"栋",enableSorting:!1,visible:!1,enableColumnMenu:!1,width:60,cellTemplate:"ridgepole.html"},{field:"agency_house.unity_name",displayName:"单元",visible:!1,enableColumnMenu:!1,width:50,cellTemplate:"unity.html"},{field:"agency_house.door_name",displayName:"门牌",enableSorting:!1,visible:!1,enableColumnMenu:!1,width:50,cellTemplate:"door.html"},{field:"agency_house.arch_square",displayName:"面积",width:80,enableColumnMenu:!1,enableHiding:!1,type:"number"},{field:"agency_house.room",displayName:"户型",enableHiding:!1,enableColumnMenu:!1,width:80,headerCellClass:"text-center",cellTemplate:"structure.html"},{field:"agency_house.floor_name",displayName:"楼层",enableColumnMenu:!1,width:60,headerCellClass:"text-center",cellTemplate:"floor.html"},{field:"high_price",displayName:"售价",width:80,visible:!0,enableColumnMenu:!1,enableSorting:!0,type:"number",cellTemplate:'<div style="background:#f0f9f7;height: 100%;padding-top: 6px;">{{row.entity.high_price}}</div>'},{field:"sale_unit_price",displayName:"单价",width:80,enableColumnMenu:!1,enableSorting:!0,type:"number",cellTemplate:'<div style="background:#f0f9f7;height: 100%;padding-top: 6px;">{{row.entity.sale_unit_price}}</div>'},{field:"lease_price",displayName:"租金",width:60,visible:!0,enableColumnMenu:!1,enableSorting:!0,type:"number"},{field:"click_num",displayName:"点击",width:50,visible:!0,enableColumnMenu:!1,type:"number"},{field:"seen_num",displayName:"带看",width:50,visible:!0,enableColumnMenu:!1,type:"number",sortDirectionCycle:[null,c.DESC,c.ASC]},{field:"share_num",displayName:"分享",width:50,visible:!0,enableColumnMenu:!1,type:"number",cellTemplate:'<div style="height: 100%;padding-top: 6px;">{{row.entity.share_num}}</div>'},{field:"discussed_num",displayName:"磋商",width:70,visible:!0,enableColumnMenu:!1,type:"number"},{field:"come_from",displayName:"来源",width:70,visible:!0,enableColumnMenu:!1},{field:"seen_at",displayName:"最后带看时间",width:130,visible:!1,enableColumnMenu:!1,type:"date"},{field:"discussed_at",displayName:"最后磋商时间",width:130,visible:!1,enableColumnMenu:!1,type:"date"},{field:"created_at",displayName:"创建时间",width:140,visible:!1,enableColumnMenu:!1,type:"date"},{field:"followed_at",displayName:"最后跟进",enableSorting:!0,enableHiding:!0,visible:!0,width:110,enableColumnMenu:!1,cellTemplate:"followed_at.html"},{field:"open_at",displayName:"开盘时间",enableSorting:!0,enableHiding:!0,visible:!0,width:110,enableColumnMenu:!1,type:"date",cellTemplate:"open_at.html"},{field:"agency_house.community_type",displayName:"物业",width:80,enableColumnMenu:!1},{field:"agency_house.direction",displayName:"朝向",width:80,enableColumnMenu:!1},{field:"verify_agent_id",displayName:"核盘人",width:60,visible:!0,enableColumnMenu:!1,cellTemplate:"verify.html",type:"number"},{field:"open_agent_id",displayName:"开盘人",enableSorting:!0,width:60,enableColumnMenu:!1,headerCellClass:"text-center",cellTemplate:"opener.html",type:"number"},{field:"uuid",displayName:"编号",width:170,enableColumnMenu:!0,visible:!1,cellTemplate:"uuid.html"},{field:"level",displayName:"级别",width:50,visible:!1,enableColumnMenu:!1},{field:"ddd",displayName:" ",enableColumnMenu:!1,enableHiding:!1,enableSorting:!1}],enableGridMenu:!0,exporterMenuPdf:!1,exporterMenuCsv:!1,rowTemplate:"rowTemplate.html",showFooter:!0,totalItems:0,enablePaging:!0,useExternalPagination:!0,paginationCurrentPage:1,paginationPageSizes:[30,60,120],enableRowSelection:!0,enableRowHeaderSelection:!0,enableSorting:!0,enableSelectAll:!0,multiSelect:!0,onRegisterApi:function(n){e.gridApi=n,e.gridApi.pagination.on.paginationChanged(e,function(n,a){e.basic_search.page=n,e.basic_search.page_size=a,e.gridOptions.paginationCurrentPage=n,e.gridOptions.paginationPageSize=a,e.getSources()}),e.gridApi.core.on.sortChanged(e,function(n,a){0===a.length?e.getSources():("category"==a[0].name?e.basic_search.intelligence_order="category":"district.name"==a[0].name?e.basic_search.intelligence_order="district_id":"business.name"==a[0].name?e.basic_search.intelligence_order="business_id":"agency_house.ridgepole_name"==a[0].name?e.basic_search.intelligence_order="agency_house_id":"community.title"==a[0].name?e.basic_search.intelligence_order="community_id":"agency_house.arch_square"==a[0].name?e.basic_search.intelligence_order="agency_house_id":"agency_house.unity_name"==a[0].name?e.basic_search.intelligence_order="agency_house_id":"agency_house.door_name"==a[0].name?e.basic_search.intelligence_order="agency_house_id":"agency_house.room"==a[0].name?e.basic_search.intelligence_order="agency_house_id":"agency_house.floor_name"==a[0].name?e.basic_search.intelligence_order="agency_house_id":"agency_house.community_type"==a[0].name?e.basic_search.intelligence_order="agency_house_id":"agency_house.direction"==a[0].name?e.basic_search.intelligence_order="agency_house_id":"high_price"==a[0].name?e.basic_search.intelligence_order="high_price":"sale_unit_price"==a[0].name?e.basic_search.intelligence_order="sale_unit_price":"lease_price"==a[0].name?e.basic_search.intelligence_order="lease_price":"sale_status"==a[0].name?e.basic_search.intelligence_order="sale_status":"verify.name"==a[0].name?e.basic_search.intelligence_order="verify_agent_id":"open_agent_id"==a[0].name?e.basic_search.intelligence_order="open_agent_id":"click_num"==a[0].name?e.basic_search.intelligence_order="click_num":"seen_num"==a[0].name?e.basic_search.intelligence_order="seen_num":"share_num"==a[0].name?e.basic_search.intelligence_order="share_num":"discussed_num"==a[0].name?e.basic_search.intelligence_order="discussed_num":"come_from"==a[0].name?e.basic_search.intelligence_order="come_from":"seen_at"==a[0].name?e.basic_search.intelligence_order="seen_at":"discussed_at"==a[0].name?e.basic_search.intelligence_order="discussed_at":"agency_house.community_type"==a[0].name?e.basic_search.intelligence_order="agency_house.community_type":"created_at"==a[0].name?e.basic_search.intelligence_order="created_at":"followed_at"==a[0].name?e.basic_search.intelligence_order="followed_at":"open_at"==a[0].name?e.basic_search.intelligence_order="open_at":"level"==a[0].name?e.basic_search.intelligence_order="level":e.basic_search.intelligence_order=a[0].field,e.basic_search.asc=a[0].sort.direction,e.getSources())})}},e.unSelectAll=function(){e.gridApi.selection.clearSelectedRows()},e.markSourceRecord=function(n){e.unSelectAll(),angular.forEach(e.gridOptions.data,function(a,t){if(a.id==n)return e.gridApi.selection.selectRow(e.gridOptions.data[t]),!1})},e.changeSourcesAgent=function(){r.open({backdrop:!1,templateUrl:"change-open.html",controller:"OpenersCtrl",appendTo:angular.element(document.getElementById("sources")),size:"md"})},n.$on("sync-source-lists",function(n,a){e.getSources("from")}),n.$on("get-page-source",function(a,t){var i=0;"next"===t.direction?(i=-1,e.ids.length&&(e.nextSourceId=e.ids[_.indexOf(e.ids,t.sourceId)+1],void 0!==e.nextSourceId&&(i=e.nextSourceId))):e.ids.length&&(e.prevSourceId=e.ids[_.indexOf(e.ids,t.sourceId)-1],void 0!==e.prevSourceId&&(i=e.prevSourceId)),e.markSourceRecord(i>0?i:t.sourceId),n.$broadcast("pass-page-sourceId",{sourceId:i})}),n.$on("update-source-one-in-list",function(n,a){e.unSelectAll(),void 0!==a&&a.id&&angular.forEach(e.gridOptions.data,function(n,t){if(n.id===a.id)return e.gridOptions.data[t]=a,e.gridApi.selection.selectRow(e.gridOptions.data[t]),!1})}),n.$on("update-item-source-list",function(n,a){"暂缓"==a.sale_status?e.getSources():_.find(e.gridOptions.data,function(n,t){n.id==a.id&&(e.gridOptions.data[t]=angular.merge(e.gridOptions.data[t],a))})}),n.$on("update-source-list",function(n,a){_.find(e.gridOptions.data,function(n,t){n.id==a.id&&("del"==a.action?"keys"==a.type&&(e.gridOptions.data[t].key_agent_id=null):"add"==a.action&&"keys"==a.type&&(e.gridOptions.data[t].key_agent_id=a.agent_id),e.gridApi.selection.selectRow(e.gridOptions.data[t]))})}),n.$on("update-source-one-pic-in-list",function(n,a){angular.forEach(e.gridOptions.data,function(n,t){n.id==a[0]&&(e.gridOptions.data[t].if_pic=a[1])})}),e.getSources=function(){e.ids=[];var n=$.search.source(),i=$('input[data-toggle="erp-comunity-dictionary"]').val();i&&(n.community_name=i),$.loading.show(),"?mine"!==RunningLeeUrl.parse().search&&(e.search=angular.extend(e.basic_search,n),e.me=n),e.search.company_area_id=e.me.company_area_id,e.search.store_id=e.me.store_id,e.search.store_group_id=e.me.store_group_id,e.search.district_id=e.me.district_id,e.search.business_id=e.me.business_id,e.search.counter="no",t.get("/api/source?"+$.param(e.search)).then(function(n){e.gridOptions.data=n.data.data,angular.forEach(e.gridOptions.data,function(n){e.ids.push(n.id),n.only_end_date>s("date")(new Date((new Date).setDate((new Date).getDate()-1)),"yyyy-MM-dd")?n.only_state=!0:n.only_state=!1})},function(e){Message.error(e)}).finally(function(){$.loading.hide(),e.unSelectAll(),a(function(){e.search.counter="yes",t.get("/api/source?"+$.param(e.search)).then(function(n){e.gridOptions.totalItems=n.data.total}),$("#sources .ui-grid-render-container-body .ui-grid-viewport").css("overflow-x","scroll")},1e3)})},e.getCommunities=function(){e.search={keyword:"",page:1,status:"已审核",pageSize:30},t.get("/api/dictionary?"+$.param(e.search)).then(function(n){e.morecommunities=n.data.data})},n.$on("sync-detail-only",function(n,a){e.getSources()}),e.init=function(){e.getLocation()},e.init(),e.multiTransfer=function(e){r.open({animation:!0,backdrop:!1,templateUrl:"multi-transfer.html",controller:"MultiTransferCtrl",appendTo:angular.element(document.getElementById("main-window")),size:"dialog-720 gray-header",resolve:{share:function(){return{from:"sources",type:e}}}})},e.selectionId=function(n){e.selectIds=[],e.not_org=!1,angular.forEach(e.gridApi.selection.getSelectedRows(),function(a,t,i){e.selectIds.push(a.id),e.gov.roler.store_group&&(e.gov.store_group_id!=a.store_group_id&&"open"==n&&(e.not_org=!0),e.gov.store_group_id!=a.verify_group_id&&"verify"==n&&(e.not_org=!0)),e.gov.roler.store&&(e.gov.store_id!=a.open_store_id&&"open"==n&&(e.not_org=!0),e.gov.store_id!=a.verify_store_id&&"verify"==n&&(e.not_org=!0)),e.gov.roler.company_area&&(e.gov.company_area_id!=a.company_area_id&&"open"==n&&(e.not_org=!0),e.gov.company_area_id!=a.verify_company_area_id&&"verify"==n&&(e.not_org=!0)),e.gov.roler.company_big_area&&(e.gov.company_big_area_id!=a.company_big_area_id&&"open"==n&&(e.not_org=!0),e.gov.company_big_area_id!=a.verify_company_big_area_id&&"verify"==n&&(e.not_org=!0))})},e.openTransfer=function(n){return e.selectionId(n),e.selectIds.length||"all"==n?e.not_org&&"all"!=n?(Message.warning("您转移的房源含有非本部的房源，请剔除掉！"),!1):void r.open({animation:!0,backdrop:!1,templateUrl:"all"==n?"openTransfer-all.html":"openTransfer.html",controller:"openTransferCtrl",appendTo:angular.element(document.getElementById("main-window")),size:"dialog-510",resolve:{share:function(){return{type:n,selectIds:e.selectIds,selected:e.gridApi.selection.getSelectedRows()}}}}).result.then(function(n){n&&(e.transfer_disabled=!0,e.transfer_title="正在进行数据迁移, 请稍后自行刷新页面查查看进度。"),e.refreshWindow()},function(){}):(Message.warning("请选择房源！"),!1)},e.transfer_disabled=!1,e.transfer_title="批量转移",e.refreshWindow=function(){e.myrefresh(),e.refresh=l(function(){e.myrefresh()},5e3,-1)},e.myrefresh=function(){t.get("/api/source-transfer-cache").then(function(n){0==n.data?(l.cancel(e.refresh),e.transfer_disabled=!1,e.transfer_title="批量转移"):(e.transfer_disabled=!0,e.transfer_title="正在进行数据迁移, 请稍后自行刷新页面查查看进度。")})},e.refreshWindow(),$(window).resize(function(){a(function(){var e=$(".ui-grid-render-container-body .ui-grid-viewport")[0].clientHeight;$("#sources .ui-grid-render-container-left .ui-grid-viewport").css("height",e)},200)})}).controller("AddSourceAlertCtrl",function(e,n,a,t,i,o){e.communitySelect="",e.ownerRelation=t.relations,e.item={sex:"先生",relation:"本人",phone_type:"手机"},e.if_locked=0,a.get("/api/getsourceconfig").then(function(n){e.if_locked=n.data.locked,e.if_unit=n.data.if_unit});var r=/^1(3|4|5|7|8)\d{9}$/,s=/^(0[1-9][0-9]{1,2})[0-9]{7,8}$/,l=/^(((13[0-9])|(15([0-3]|[5-9])|(17[0-9])|(18[0-9])))\d{8})|(0[1-2]\d{9})|(0[3-9]\d{10,11})$/;e.search={page:1,pageSize:30,keywords:""},e.close=function(){i.close()},e.showInfo=function(e){$.loading.show(),a.get("/api/source/"+e.id).then(function(n){var a=Date.parse(new Date);o.open({backdrop:!1,templateUrl:"/source/next-sources.html?source_id="+e.id+"&time="+a,controller:"nextsourceSCtrl",appendTo:angular.element(document.getElementById("sources")),size:"dialog-800",resolve:{share:function(){return{source:n.data.data,access:n.data.access,agent:n.data.agent,setting:n.data.setting}}}}),$.loading.hide()})},e.clearNoNum=function(e,n){void 0!=e[n]&&(e[n]=e[n].replace(/[^\d.]/g,""),e[n]=e[n].replace(/^\./g,""),e[n]=e[n].replace(/\.{2,}/g,""),e[n]=e[n].replace(".","$#$").replace(/\./g,"").replace("$#$","."))},e.refresh=function(n){""!=n&&(e.search.keyword=n,e.search.status=1,e.getCommunities())},e.clear=function(){e.item.ridgepole_name="",e.item.ridgepole_id="",e.item.unity_name="",e.item.unity_id="",e.item.floor_name="",e.item.total_floor="",e.item.floor_id="",e.item.door_name="",e.item.door_id=""},e.getCommunities=function(){e.search.status="已审核",a.get("/api/dictionary?"+$.param(e.search)).then(function(n){e.communities=n.data.data})},e.showRidgepole=function(n){e.clear(),e.item.community_id=n.id,e.item.community_name=n.title,n.ridgepole_count?($("#total_floor").attr("readonly",!0),$("#door_name").attr("readonly",!0),$("#floor_name").attr("readonly",!0),$("#unity_name").attr("readonly",!0),$("#ridgepole_name").attr("readonly",!0),$("#showReselect").show(),o.open({backdrop:!1,templateUrl:"community-house.html",controller:"ridgepoleSCtrl",appendTo:angular.element(document.getElementById("sources")),size:"community-720",resolve:{share:function(){return{community:n}}}})):e.if_locked&&($("#total_floor").attr("readonly",!1),$("#door_name").attr("readonly",!1),$("#floor_name").attr("readonly",!1),e.if_unit&&$("#unity_name").attr("readonly",!1),$("#ridgepole_name").attr("readonly",!1),$("#showReselect").hide())},e.showRidgepoleAgain=function(n){e.clear(),e.existenceSource=!1,e.item.community_id=n,a.get("/api/community/"+e.item.community_id).then(function(n){0!=n.data.length?o.open({backdrop:!1,templateUrl:"community-house.html",controller:"ridgepoleSCtrl",appendTo:angular.element(document.getElementById("sources")),size:"community-720",resolve:{share:function(){return{community:n.data}}}}):(e.existenceSource=!1,e.is_verified=!0)})},n.$on("selected-door",function(n,a){e.item.ridgepole_name=a.info.floor.unity.ridgepole.name,e.item.ridgepole_id=a.info.floor.unity.ridgepole.id,e.item.unity_name=a.info.floor.unity.name,e.item.unity_id=a.info.floor.unity.id,e.item.floor_name=a.info.floor.name,e.item.floor_id=a.info.floor.id,e.item.door_name=a.info.name,e.item.total_floor=a.info.floor.unity.max_layer,e.item.door_id=a.info.id}),e.name=function(){parseInt(e.item.total_floor)<parseInt(e.item.floor_name)&&(e.item.floor_name="")},e.total=function(){parseInt(e.item.floor_name)>parseInt(e.item.total_floor)&&(e.item.total_floor="")},e.nextOperation=function(){if(e.loading_add=!1,!l.test(e.item.mobile)||l.exec(e.item.mobile)[0]!==e.item.mobile)return Message.warning("电话格式不正确"),!1;e.loading_add=!0,e.item.main_num3="1",a.post("/api/check-source-by-mobile",e.item).then(function(n){e.close(),o.open({backdrop:!1,templateUrl:"/source/next-sources.html?source_id=0&time="+Date.parse(new Date),controller:"nextsourceSCtrl",appendTo:angular.element(document.getElementById("sources")),size:"dialog-800",resolve:{share:function(){return{source:n.data.data,access:n.data.access,agent:n.data.agent,setting:n.data.setting}}}})},function(n){Message.error(n),e.showexistenceSource=1,a.get("/api/checksource?"+$.param(e.item)).then(function(n){e.existenceSource=n.data})}).finally(function(){e.loading_add=!1})},e.verifySource=function(){if(!r.test(e.item.mobile)&&!s.test(e.item.mobile))return Message.warning("电话格式不正确"),!1;e.loading_add=!0,e.item.main_num3="1",a.post("/api/createtempsource",e.item).then(function(n){Message.success("核盘成功!"),e.close()},function(e){"门牌号已经存在。"==e.data.message?Message.warning(e.data.message):Message.error(e)}).finally(function(){e.showexistenceSource=1,a.get("/api/checksource?"+$.param(e.item)).then(function(n){e.existenceSource=n.data}),e.loading_add=!1})},e.running=function(){e.getCommunities()},e.running()}).controller("openTransferCtrl",function(e,n,a,t,i,o,r){e.close=function(){a.close(e.loadding)},e.selectIds=t.selectIds,e.type=t.type,e.set={setting:["公司公盘","大区公盘","区公盘","店公盘","组公盘"]},e.to_org={},e.from_org={},e.getOrg=function(n){"to"==n?(e.to_org.company_id=e.org2.company_id,e.to_org.company_big_area_id=e.org2.company_big_area_id,e.to_org.company_area_id=e.org2.company_area_id,e.to_org.store_id=e.org2.store_id,e.to_org.store_group_id=e.org2.store_group_id,e.to_org.agent_id=e.org2.agent_id,0===e.org2.company_id?e.isClicked=!1:(e.isClicked=!0,"all"!=e.type||e.from_org.company_id||(e.isClicked=!1))):(e.from_org.company_id=e.org.company_id,e.from_org.company_big_area_id=e.org.company_big_area_id,e.from_org.company_area_id=e.org.company_area_id,e.from_org.store_id=e.org.store_id,e.from_org.store_group_id=e.org.store_group_id,e.from_org.agent_id=e.org.agent_id,0===e.org.company_id?e.isClicked=!1:(e.isClicked=!0,"all"!=e.type||e.to_org.company_id||(e.isClicked=!1)))},e.transferSure=function(n){if($.isEmptyObject(e.to_org))return Message.warning("没选择转移目标"),!1;if("all"==n&&$.isEmptyObject(e.from_org))return Message.warning("没选择原所属人"),!1;if("all"==n&&angular.equals(e.from_org,e.to_org))return Message.warning("所属人相同"),!1;if("all"!=n){if(e.sameOrg(),e.same_org)return Message.warning("您转移的房源含有本目标的房源，请剔除掉！"),!1;if(e.open_not)return Message.warning("您转移的房源含有"+e.gov.respite_display+"的房源，请剔除掉！"),!1}e.data={},e.data="all"==n?{type:n,from_org:e.from_org,to_org:e.to_org}:{type:n,ids:e.selectIds,to_org:e.to_org},swal({title:"是否要转移此批房源?",text:"转移后不可恢复",type:"warning",confirmButtonColor:"#DD6B55",confirmButtonText:"确定",cancelButtonText:"取消",showCancelButton:!0,closeOnConfirm:!1,showLoaderOnConfirm:!0},function(){swal.close(),e.loading_save=!0,e.loadding=!0,i.post("/api/source-transfer",e.data).then(function(n){n.data.success?1==n.data.work?e.refresh=o(function(){e.myrefresh(n.data.msg)},5e3,-1):(toastr.success(n.data.msg,"操作成功",{progressBar:!0,positionClass:"toast-top-center",closeButton:!0}),e.close(),r.$emit("sync-source-lists",{})):(Message.warning(n.data.msg),e.loading_save=!1,e.loadding=!1)},function(n){e.loading_save=!1,e.loadding=!1,Message.error(n)})})},e.myrefresh=function(n){i.get("/api/source-transfer-cache").then(function(a){0==a.data&&(e.loadding=!1,o.cancel(e.refresh),toastr.success(n,"操作成功",{progressBar:!0,positionClass:"toast-top-center",closeButton:!0}),e.close(),r.$emit("sync-source-lists",{}))})},e.sameOrg=function(){e.same_org=!1,e.open_not=!1,angular.forEach(t.selected,function(n){var a={};"open"==e.type&&(a={agent_id:n.open_agent_id,store_group_id:n.store_group_id,store_id:n.open_store_id,company_area_id:n.company_area_id,company_big_area_id:n.company_big_area_id,company_id:n.company_id}),"verify"==e.type&&(a={agent_id:n.verify_agent_id,store_group_id:n.verify_group_id,store_id:n.verify_store_id,company_area_id:n.verify_company_area_id,company_big_area_id:n.verify_company_big_area_id,company_id:n.company_id}),angular.equals(a,e.to_org)&&(e.same_org=!0),"暂缓"==n.sale_status&&"open"==e.type&&(e.open_not=!0)})}});